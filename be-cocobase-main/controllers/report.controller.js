const PDFDocument = require("pdfkit");
const prisma = require("../libs/prisma");
const path = require("path");

const generateReport = async (req, res, next) => {
    try {
        const { deviceId, type, start, end, petaniId } = req.query;

        // Get user info from JWT token (if available)
        const userName = req.user?.nama || req.user?.name || "System";
        const userEmail = req.user?.email || "-";

        let dateFilter = {};
        const now = new Date();
        let periodLabel = "Custom Period";

        if (type === "daily") {
            const startOfDay = new Date(now);
            startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(now);
            endOfDay.setHours(23, 59, 59, 999);
            dateFilter = {
                gte: startOfDay,
                lte: endOfDay,
            };
            periodLabel = `Daily (${startOfDay.toLocaleDateString("id-ID")})`;
        } else if (type === "weekly") {
            const firstDay = new Date(now);
            firstDay.setDate(now.getDate() - now.getDay());
            firstDay.setHours(0, 0, 0, 0);
            dateFilter = {
                gte: firstDay,
            };
            periodLabel = `Weekly (Starting ${firstDay.toLocaleDateString("id-ID")})`;
        } else if (type === "monthly") {
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            dateFilter = {
                gte: monthStart,
            };
            periodLabel = `Monthly (${monthStart.toLocaleDateString("id-ID", { month: "long", year: "numeric" })})`;
        } else if (start && end) {
            dateFilter = {
                gte: new Date(start),
                lte: new Date(end),
            };
            periodLabel = `${new Date(start).toLocaleDateString("id-ID")} - ${new Date(end).toLocaleDateString("id-ID")}`;
        }

        const device = await prisma.device.findUnique({
            where: { id: parseInt(deviceId) },
        });

        if (!device) {
            return res.status(404).json({ success: false, message: "Device not found" });
        }

        let farmerName = "All Farmers";
        if (petaniId && petaniId !== "undefined" && petaniId !== "") {
            const farmer = await prisma.petani.findUnique({
                where: { id: parseInt(petaniId) },
            });
            if (farmer) {
                farmerName = farmer.nama;
            }
            dateFilter.petaniId = parseInt(petaniId);
        }

        const logs = await prisma.packingLog.findMany({
            where: {
                deviceId: parseInt(deviceId),
                createdAt: dateFilter.createdAt ? dateFilter.createdAt : dateFilter,
                ...(dateFilter.petaniId ? { petaniId: dateFilter.petaniId } : {})
            },
            orderBy: { createdAt: "asc" },
            include: {
                petani: true,
            },
        });

        // Calculate summary statistics
        const totalRecords = logs.length;
        const totalWeight = logs.reduce((sum, log) => sum + log.weight, 0);
        const avgWeight = totalRecords > 0 ? totalWeight / totalRecords : 0;
        const firstLog = logs.length > 0 ? logs[0] : null;
        const lastLog = logs.length > 0 ? logs[logs.length - 1] : null;

        const doc = new PDFDocument({ margin: 50 });
        let filename = `Report_${device.name}_${type || 'custom'}.pdf`;

        res.setHeader("Content-Type", "application/pdf");
        res.setHeader("Content-Disposition", `attachment; filename=${filename}`);

        doc.pipe(res);

        // ============ HEADER ============
        doc.fontSize(22).font("Helvetica-Bold").text("COCOBASE", { align: "center" });
        doc.fontSize(14).font("Helvetica").text("Packing Report", { align: "center" });
        doc.moveDown(0.5);
        doc.moveTo(50, doc.y).lineTo(550, doc.y).stroke();
        doc.moveDown();

        // ============ REPORT INFO ============
        doc.fontSize(10).font("Helvetica");
        doc.text(`Device Name: ${device.name}`, 50);
        doc.text(`Device Token: ${device.token}`);
        doc.text(`Device Token: ${device.token}`);
        doc.text(`Report Period: ${periodLabel}`);
        doc.text(`Filter Farmer: ${farmerName}`);
        doc.moveDown(0.5);
        doc.text(`Generated By: ${userName} (${userEmail})`);
        doc.text(`Generated At: ${new Date().toLocaleString("id-ID")}`);
        doc.moveDown();

        // ============ SUMMARY BOX ============
        const summaryY = doc.y;
        doc.rect(50, summaryY, 500, 80).fillAndStroke("#f9fafb", "#e5e7eb");

        doc.fillColor("#000000").fontSize(11).font("Helvetica-Bold");
        doc.text("SUMMARY", 60, summaryY + 10);

        doc.fontSize(10).font("Helvetica");
        doc.text(`Total Records: ${totalRecords}`, 60, summaryY + 30);
        doc.text(`Total Weight: ${totalWeight.toFixed(2)} kg`, 60, summaryY + 45);
        doc.text(`Average Weight: ${avgWeight.toFixed(2)} kg`, 60, summaryY + 60);

        doc.text(`Target Threshold: ${device.threshold} kg`, 300, summaryY + 30);
        if (firstLog) {
            doc.text(`First Record: ${new Date(firstLog.createdAt).toLocaleString("id-ID")}`, 300, summaryY + 45);
        }
        if (lastLog) {
            doc.text(`Last Record: ${new Date(lastLog.createdAt).toLocaleString("id-ID")}`, 300, summaryY + 60);
        }

        doc.y = summaryY + 95;
        doc.moveDown();

        // ============ TABLE HEADER ============
        const tableTop = doc.y;
        doc.fontSize(10).font("Helvetica-Bold").fillColor("#374151");
        doc.text("No", 50, tableTop);
        doc.text("Date & Time", 80, tableTop);
        doc.text("Weight (kg)", 280, tableTop);
        doc.text("Farmer", 380, tableTop);
        doc.text("Status", 480, tableTop);

        doc.moveTo(50, tableTop + 15).lineTo(550, tableTop + 15).stroke("#d1d5db");

        // ============ TABLE CONTENT ============
        doc.font("Helvetica").fontSize(9).fillColor("#000000");
        let y = tableTop + 25;

        if (logs.length === 0) {
            doc.text("No records found for this period.", 50, y);
        } else {
            logs.forEach((log, index) => {
                if (y > 720) {
                    doc.addPage();
                    y = 50;
                }
                doc.text(String(index + 1), 50, y);
                doc.text(new Date(log.createdAt).toLocaleString("id-ID"), 80, y);
                doc.text(`${log.weight.toFixed(2)} kg`, 280, y);
                doc.text(log.petani ? log.petani.nama : "-", 380, y);
                doc.fillColor("#059669").text("Success", 480, y);
                doc.fillColor("#000000");
                y += 18;
            });
        }

        // ============ FOOTER ============
        doc.fontSize(8).fillColor("#9ca3af");
        doc.text(
            `Cocobase IoT Packing System - Page 1`,
            50,
            750,
            { align: "center", width: 500 }
        );

        doc.end();
    } catch (err) {
        next(err);
    }
};

module.exports = { generateReport };
